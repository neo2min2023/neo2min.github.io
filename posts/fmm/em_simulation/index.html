<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EM_simulation | Research Notes</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/mathjax.css" />
    
    
    
     
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>

 












 
    
    

  </head>

  <body>
    <nav>
    <ul class="menu">
      
    </ul>
    <hr/>
    </nav>


    <h2>EM_simulation</h2>
    <h4>2023-04-18 17:55:43 &#43;0800 CST</h4>
    <aside>
        <nav id="TableOfContents">
  <ol>
    <li><a href="#em-algorithm-for-normal-mixture-models">EM algorithm for normal mixture models</a>
      <ol>
        <li><a href="#new-version">new version</a></li>
        <li><a href="#old-version">old version</a></li>
        <li><a href="#e-step">E-step</a></li>
        <li><a href="#m-step">M-step</a></li>
        <li><a href="#simulation">Simulation</a></li>
      </ol>
    </li>
    <li><a href="#em-algorithm-for-binomial-mixture-models">EM algorithm for binomial mixture models</a></li>
  </ol>
</nav>
    </aside>
    <hr>
    <h1 id="em-algorithm-for-normal-mixture-models">EM algorithm for normal mixture models</h1>
<h2 id="new-version">new version</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># initial values</span>
</span></span><span style="display:flex;"><span>pi1_0 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.4</span>
</span></span><span style="display:flex;"><span>pi2_0 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.6</span>
</span></span><span style="display:flex;"><span>mu1_0 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">-1</span>
</span></span><span style="display:flex;"><span>mu2_0 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>sigma1_0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>sigma2_0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>N <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>maxIter <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>loglik <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rep</span>(<span style="color:#66d9ef">NA</span>, maxIter)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.table</span>(grp<span style="color:#f92672">=</span><span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>), N, replace<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>, prob<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(pi1_0, pi2_0)), x1<span style="color:#f92672">=</span><span style="color:#a6e22e">rnorm</span>(N, mu1_0, sigma1_0^2), x2<span style="color:#f92672">=</span><span style="color:#a6e22e">rnorm</span>(N, mu2_0, sigma2_0^2))
</span></span><span style="display:flex;"><span>df[, x<span style="color:#f92672">:=</span><span style="color:#a6e22e">fifelse</span>(grp<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>, x1, x2)]
</span></span><span style="display:flex;"><span>kde_x <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">density</span>(x)]
</span></span><span style="display:flex;"><span>df[, <span style="color:#a6e22e">plot</span>(kde_x)]
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-2-1.png" alt=""><!-- raw HTML omitted --></p>
<pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>xs <span style="color:#f92672">&lt;-</span> kde_x<span style="color:#f92672">$</span>x
</span></span><span style="display:flex;"><span>df[, <span style="color:#a6e22e">plot</span>(kde_x, ylim<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">-1.1</span>, <span style="color:#ae81ff">0.55</span>), lwd<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)]
</span></span></code></pre></div><pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>df[, <span style="color:#a6e22e">points</span>(x, <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0</span>, N), pch<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, cex<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)]
</span></span></code></pre></div><pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>mu1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">quantile</span>(x, <span style="color:#ae81ff">0.25</span>)]
</span></span><span style="display:flex;"><span>mu2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">quantile</span>(x, <span style="color:#ae81ff">0.75</span>)]
</span></span><span style="display:flex;"><span>pi1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>pi2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>sigma1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sd</span>(x)]
</span></span><span style="display:flex;"><span>sigma2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sd</span>(x)]
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#66d9ef">pi</span><span style="color:#f92672">*</span>sigma1^2) <span style="color:#f92672">*</span> <span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">-1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sigma1^2)<span style="color:#f92672">*</span>(xs<span style="color:#f92672">-</span>mu1)^2), col<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#66d9ef">pi</span><span style="color:#f92672">*</span>sigma2^2) <span style="color:#f92672">*</span> <span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">-1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sigma2^2)<span style="color:#f92672">*</span>(xs<span style="color:#f92672">-</span>mu2)^2), col<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;green&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">20</span>){
</span></span><span style="display:flex;"><span>    df[, prob1<span style="color:#f92672">:=</span><span style="color:#a6e22e">dnorm</span>(x, mu1, sigma1)]
</span></span><span style="display:flex;"><span>    df[, prob2<span style="color:#f92672">:=</span><span style="color:#a6e22e">dnorm</span>(x, mu2, sigma2)]
</span></span><span style="display:flex;"><span>    df[, probTot<span style="color:#f92672">:=</span>pi1<span style="color:#f92672">*</span>prob1<span style="color:#f92672">+</span>pi2<span style="color:#f92672">*</span>prob2]
</span></span><span style="display:flex;"><span>    df[, post1<span style="color:#f92672">:=</span>pi1 <span style="color:#f92672">*</span> prob1<span style="color:#f92672">/</span>probTot]
</span></span><span style="display:flex;"><span>    df[, post2<span style="color:#f92672">:=</span>pi2 <span style="color:#f92672">*</span> prob2<span style="color:#f92672">/</span>probTot]
</span></span><span style="display:flex;"><span>    df[, color<span style="color:#f92672">:=</span><span style="color:#a6e22e">rgb</span>(post1, post2, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)]
</span></span><span style="display:flex;"><span>    pi1 <span style="color:#f92672">&lt;-</span>  df[, <span style="color:#a6e22e">sum</span>(post1)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    pi2 <span style="color:#f92672">&lt;-</span>  df[, <span style="color:#a6e22e">sum</span>(post2)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    mu1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sum</span>(x<span style="color:#f92672">*</span>post1)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post1)]
</span></span><span style="display:flex;"><span>    mu2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sum</span>(x<span style="color:#f92672">*</span>post2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post2)]
</span></span><span style="display:flex;"><span>    sigma1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>(post1 <span style="color:#f92672">*</span>(x<span style="color:#f92672">-</span>mu1)^2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post1))]
</span></span><span style="display:flex;"><span>    sigma2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>(post2 <span style="color:#f92672">*</span>(x<span style="color:#f92672">-</span>mu2)^2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post2))]
</span></span><span style="display:flex;"><span>    df[, <span style="color:#a6e22e">points</span>(x, <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">-0.05</span><span style="color:#f92672">*</span>i, N), pch<span style="color:#f92672">=</span><span style="color:#ae81ff">19</span>, cex<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, col<span style="color:#f92672">=</span>color)]
</span></span><span style="display:flex;"><span>    df[, <span style="color:#a6e22e">lines</span>(xs, <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#66d9ef">pi</span><span style="color:#f92672">*</span>sigma1^2) <span style="color:#f92672">*</span> <span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">-1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sigma1^2)<span style="color:#f92672">*</span>(xs<span style="color:#f92672">-</span>mu1)^2), col<span style="color:#f92672">=</span><span style="color:#a6e22e">rgb</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>))]
</span></span><span style="display:flex;"><span>    df[, <span style="color:#a6e22e">lines</span>(xs, <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#66d9ef">pi</span><span style="color:#f92672">*</span>sigma2^2) <span style="color:#f92672">*</span> <span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">-1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>sigma2^2)<span style="color:#f92672">*</span>(xs<span style="color:#f92672">-</span>mu2)^2), col<span style="color:#f92672">=</span><span style="color:#a6e22e">rgb</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>))]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">text</span>(<span style="color:#a6e22e">rep</span>(<span style="color:#a6e22e">min</span>(xs)<span style="color:#ae81ff">+2.4</span>, <span style="color:#ae81ff">21</span>), <span style="color:#a6e22e">seq</span>(from<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, to<span style="color:#f92672">=</span>(<span style="color:#ae81ff">-0.05</span><span style="color:#f92672">*</span><span style="color:#ae81ff">20</span>), by<span style="color:#f92672">=</span><span style="color:#ae81ff">-0.05</span>), <span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;cluster in iteration &#34;</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">20</span>), cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.88</span>, pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;darkgreen&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">abline</span>(h<span style="color:#f92672">=</span><span style="color:#ae81ff">-1.03</span>, lty<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">text</span>(<span style="color:#a6e22e">min</span>(xs)<span style="color:#ae81ff">+2.4</span>, <span style="color:#ae81ff">-1.06</span>, <span style="color:#e6db74">&#34;true classfication&#34;</span>, cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.88</span>, pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;darkred&#34;</span>)
</span></span><span style="display:flex;"><span>df[grp<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">points</span>(x, <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">-1.05</span>, .N), pch<span style="color:#f92672">=</span><span style="color:#ae81ff">19</span>, cex<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, col<span style="color:#f92672">=</span><span style="color:#a6e22e">rgb</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>))]
</span></span></code></pre></div><pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>df[grp<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">points</span>(x, <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">-1.07</span>, .N), pch<span style="color:#f92672">=</span><span style="color:#ae81ff">19</span>, cex<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, col<span style="color:#f92672">=</span><span style="color:#a6e22e">rgb</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>))]
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-2-2.png" alt=""><!-- raw HTML omitted --></p>
<pre tabindex="0"><code>NULL
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">c</span>(pi1, pi2, mu1, mu2, sigma1, sigma2)
</span></span></code></pre></div><pre tabindex="0"><code>[1]  0.412  0.588 -1.505  2.403  0.712  2.008
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">c</span>(pi1_0, pi2_0, mu1_0, mu2_0, sigma1_0, sigma2_0)
</span></span></code></pre></div><pre tabindex="0"><code>[1]  0.40  0.60 -1.00  3.00  1.00  1.41
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>mu1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">quantile</span>(x, <span style="color:#ae81ff">0.25</span>)]
</span></span><span style="display:flex;"><span>mu2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">quantile</span>(x, <span style="color:#ae81ff">0.75</span>)]
</span></span><span style="display:flex;"><span>pi1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>pi2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>sigma1 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sd</span>(x)]
</span></span><span style="display:flex;"><span>sigma2 <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sd</span>(x)]
</span></span><span style="display:flex;"><span>paramMat <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">rep</span>(<span style="color:#66d9ef">NA</span>, <span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>maxIter), nrow<span style="color:#f92672">=</span>maxIter)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">colnames</span>(paramMat) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;pi1&#34;</span>, <span style="color:#e6db74">&#34;pi2&#34;</span>, <span style="color:#e6db74">&#34;mu1&#34;</span>, <span style="color:#e6db74">&#34;mu2&#34;</span>, <span style="color:#e6db74">&#34;sigma1&#34;</span>, <span style="color:#e6db74">&#34;sigma2&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#data.table(pi1=rep(NA, maxIter), pi2=rep(NA, maxIter), mu1=rep(NA, maxIter), mu2=rep(NA, maxIter), sigma1=rep(NA, maxIter), sigma2=rep(NA, maxIter))</span>
</span></span><span style="display:flex;"><span>paramMat[1, ] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(pi1, pi2, mu1, mu2, sigma1, sigma2)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>maxIter){
</span></span><span style="display:flex;"><span>    paramVec <span style="color:#f92672">&lt;-</span> paramMat[i<span style="color:#ae81ff">-1</span>,]
</span></span><span style="display:flex;"><span>    df[, prob1<span style="color:#f92672">:=</span><span style="color:#a6e22e">dnorm</span>(x, paramVec[<span style="color:#e6db74">&#34;mu1&#34;</span>], paramVec[<span style="color:#e6db74">&#34;sigma1&#34;</span>])]
</span></span><span style="display:flex;"><span>    df[, prob2<span style="color:#f92672">:=</span><span style="color:#a6e22e">dnorm</span>(x, paramVec[<span style="color:#e6db74">&#34;mu2&#34;</span>], paramVec[<span style="color:#e6db74">&#34;sigma2&#34;</span>])]
</span></span><span style="display:flex;"><span>    df[, probTot<span style="color:#f92672">:=</span>paramVec[<span style="color:#e6db74">&#34;pi1&#34;</span>]<span style="color:#f92672">*</span>prob1<span style="color:#f92672">+</span>paramVec[<span style="color:#e6db74">&#34;pi2&#34;</span>]<span style="color:#f92672">*</span>prob2]
</span></span><span style="display:flex;"><span>    df[, post1<span style="color:#f92672">:=</span>paramVec[<span style="color:#e6db74">&#34;pi1&#34;</span>] <span style="color:#f92672">*</span> prob1<span style="color:#f92672">/</span>probTot]
</span></span><span style="display:flex;"><span>    df[, post2<span style="color:#f92672">:=</span>paramVec[<span style="color:#e6db74">&#34;pi2&#34;</span>] <span style="color:#f92672">*</span> prob2<span style="color:#f92672">/</span>probTot]
</span></span><span style="display:flex;"><span>    df[, color<span style="color:#f92672">:=</span><span style="color:#a6e22e">rgb</span>(post1, post2, <span style="color:#ae81ff">0</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;pi1&#34;</span>] <span style="color:#f92672">&lt;-</span>  df[, <span style="color:#a6e22e">sum</span>(post1)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;pi2&#34;</span>] <span style="color:#f92672">&lt;-</span>  df[, <span style="color:#a6e22e">sum</span>(post2)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;mu1&#34;</span>] <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sum</span>(x<span style="color:#f92672">*</span>post1)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post1)]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;mu2&#34;</span>] <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sum</span>(x<span style="color:#f92672">*</span>post2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post2)]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;sigma1&#34;</span>] <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>(post1 <span style="color:#f92672">*</span>(x<span style="color:#f92672">-</span>paramVec[<span style="color:#e6db74">&#34;mu1&#34;</span>])^2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post1))]
</span></span><span style="display:flex;"><span>    paramMat[i, <span style="color:#e6db74">&#34;sigma2&#34;</span>] <span style="color:#f92672">&lt;-</span> df[, <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>(post2 <span style="color:#f92672">*</span>(x<span style="color:#f92672">-</span>paramVec[<span style="color:#e6db74">&#34;mu2&#34;</span>])^2)<span style="color:#f92672">/</span><span style="color:#a6e22e">sum</span>(post2))]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>paramMat[maxIter, ]
</span></span></code></pre></div><pre tabindex="0"><code>   pi1    pi2    mu1    mu2 sigma1 sigma2 
 0.405  0.595 -1.515  2.365  0.704  2.029 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">c</span>(pi1_0, pi2_0, mu1_0, mu2_0, sigma1_0, sigma2_0)
</span></span></code></pre></div><pre tabindex="0"><code>[1]  0.40  0.60 -1.00  3.00  1.00  1.41
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e">#https://stats.stackexchange.com/questions/55132/em-algorithm-manually-implemented</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(mixtools)
</span></span><span style="display:flex;"><span>gmm1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">normalmixEM</span>(df[,x], lambda <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, mu <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, sigma <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, k <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, mean.constr <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, sd.constr <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, epsilon <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-08</span>, maxit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>, maxrestarts<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, verb <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, fast<span style="color:#f92672">=</span><span style="color:#66d9ef">FALSE</span>, ECM <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, arbmean <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, arbvar <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span></code></pre></div><pre tabindex="0"><code>number of iterations= 39 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">str</span>(gmm1)
</span></span></code></pre></div><pre tabindex="0"><code>List of 9
 $ x         : num [1:50] 2.26 3.48 1.67 1.41 0.24 ...
 $ lambda    : num [1:2] 0.405 0.595
 $ mu        : num [1:2] -1.52 2.37
 $ sigma     : num [1:2] 0.704 2.029
 $ loglik    : num -109
 $ posterior : num [1:50, 1:2] 0.0000010952219 0.0000000000272 0.0000748225352 0.0003960382713 0.1314760282074 ...
  ..- attr(*, &#34;dimnames&#34;)=List of 2
  .. ..$ : NULL
  .. ..$ : chr [1:2] &#34;comp.1&#34; &#34;comp.2&#34;
 $ all.loglik: num [1:40] -175 -112 -111 -111 -110 ...
 $ restarts  : num 0
 $ ft        : chr &#34;normalmixEM&#34;
 - attr(*, &#34;class&#34;)= chr &#34;mixEM&#34;
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">c</span>(pi1_0, pi2_0, mu1_0, mu2_0, sigma1_0, sigma2_0)
</span></span></code></pre></div><pre tabindex="0"><code>[1]  0.40  0.60 -1.00  3.00  1.00  1.41
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">c</span>(gmm1<span style="color:#f92672">$</span>lambda, gmm1<span style="color:#f92672">$</span>mu, gmm1<span style="color:#f92672">$</span>sigma)
</span></span></code></pre></div><pre tabindex="0"><code>[1]  0.405  0.595 -1.515  2.365  0.704  2.029
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>paramMat[maxIter, ]
</span></span></code></pre></div><pre tabindex="0"><code>   pi1    pi2    mu1    mu2 sigma1 sigma2 
 0.405  0.595 -1.515  2.365  0.704  2.029 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># results of mannual EM are exactly the same as that of mixtools, not quite close to true value of parameters though.</span>
</span></span></code></pre></div><h2 id="old-version">old version</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(data.table)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#set.seed(20211009)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mu <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">5.0</span>)
</span></span><span style="display:flex;"><span>sd <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1000</span>, mean <span style="color:#f92672">=</span> mu[1], sd <span style="color:#f92672">=</span> sd[1])
</span></span><span style="display:flex;"><span>y2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">500</span>, mean <span style="color:#f92672">=</span> mu[2], sd <span style="color:#f92672">=</span> sd[2])
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(y1, y2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xs <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">seq</span>(<span style="color:#a6e22e">min</span>(y), <span style="color:#a6e22e">max</span>(y), length.out <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>) <span style="color:#75715e"># for plot density</span>
</span></span><span style="display:flex;"><span>density1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> mu[1], sd <span style="color:#f92672">=</span> sd[1])
</span></span><span style="display:flex;"><span>density2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> mu[2], sd <span style="color:#f92672">=</span> sd[2])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hist</span>(y, probability <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">max</span>(density1, density2)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(<span style="color:#a6e22e">density</span>(y), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y1, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y2, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, density1, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, density2, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-3-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="e-step">E-step</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>e_step <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(y, param) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># param: mu1, mu2, sd1, sd2, phi1, phi2</span>
</span></span><span style="display:flex;"><span>    param <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">.8</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">.5</span>, <span style="color:#ae81ff">.5</span>)
</span></span><span style="display:flex;"><span>    joint_prob_x_1_y <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(y, mean <span style="color:#f92672">=</span> param[1], sd <span style="color:#f92672">=</span> param[3]) <span style="color:#f92672">*</span> param[5]
</span></span><span style="display:flex;"><span>    joint_prob_x_2_y <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(y, mean <span style="color:#f92672">=</span> param[2], sd <span style="color:#f92672">=</span> param[4]) <span style="color:#f92672">*</span> param[6]
</span></span><span style="display:flex;"><span>    joint_lkl_y <span style="color:#f92672">&lt;-</span> joint_prob_x_1_y <span style="color:#f92672">+</span> joint_prob_x_2_y
</span></span><span style="display:flex;"><span>    prob_x_1_on_y <span style="color:#f92672">&lt;-</span> joint_prob_x_1_y <span style="color:#f92672">/</span> joint_lkl_y
</span></span><span style="display:flex;"><span>    prob_x_2_on_y <span style="color:#f92672">&lt;-</span> joint_prob_x_2_y <span style="color:#f92672">/</span> joint_lkl_y
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#logliklhd &lt;- sum(log(sum(c(param[5] * joint_prob_x_1_y, param[6] * joint_prob_x_2_y))))</span>
</span></span><span style="display:flex;"><span>    logliklhd <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">log</span>(joint_prob_x_1_y <span style="color:#f92672">+</span> joint_prob_x_2_y))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">list</span>(logliklhd <span style="color:#f92672">=</span> logliklhd, dt_lklhd_x_on_y <span style="color:#f92672">=</span> <span style="color:#a6e22e">data.table</span>(y, prob_x_1_on_y, prob_x_2_on_y)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r0_mu <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">2</span>, min <span style="color:#f92672">=</span> <span style="color:#a6e22e">min</span>(y), max <span style="color:#f92672">=</span> <span style="color:#a6e22e">max</span>(y))
</span></span><span style="display:flex;"><span>r0_sd <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">2</span>, min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, max <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(y))
</span></span><span style="display:flex;"><span>r0_mix <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_step</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">9</span>, <span style="color:#a6e22e">c</span>(r0_mu, r0_sd, r0_mix))
</span></span></code></pre></div><pre tabindex="0"><code>$logliklhd
[1] -123

$dt_lklhd_x_on_y
   y prob_x_1_on_y prob_x_2_on_y
1: 1       0.42556         0.574
2: 2       0.28905         0.711
3: 3       0.18243         0.818
4: 4       0.10910         0.891
5: 5       0.06297         0.937
6: 6       0.03557         0.964
7: 7       0.01984         0.980
8: 8       0.01099         0.989
9: 9       0.00606         0.994
</code></pre><h2 id="m-step">M-step</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_step <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(dt_lklhd_x_on_y) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#next_mu &lt;- dt_lklhd_x_on_y[, sapply(list(prob_x_1_on_y, prob_x_2_on_y), function(preLikli) { sum(y * preLikli) / sum(preLikli) })]</span>
</span></span><span style="display:flex;"><span>    next_mu <span style="color:#f92672">&lt;-</span> dt_lklhd_x_on_y[, <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">sum</span>(y <span style="color:#f92672">*</span> prob_x_1_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(prob_x_1_on_y), <span style="color:#a6e22e">sum</span>(y <span style="color:#f92672">*</span> prob_x_2_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(prob_x_2_on_y))]
</span></span><span style="display:flex;"><span>    next_sd <span style="color:#f92672">&lt;-</span> dt_lklhd_x_on_y[, <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>((y <span style="color:#f92672">-</span> next_mu[1])^2 <span style="color:#f92672">*</span> prob_x_1_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(prob_x_1_on_y)), <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">sum</span>((y <span style="color:#f92672">-</span> next_mu[2])^2 <span style="color:#f92672">*</span> prob_x_2_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(prob_x_2_on_y)))]
</span></span><span style="display:flex;"><span>    next_mix <span style="color:#f92672">&lt;-</span> dt_lklhd_x_on_y[, <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">sum</span>(prob_x_1_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>(y), <span style="color:#a6e22e">sum</span>(prob_x_2_on_y) <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>(y))]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">c</span>(next_mu, next_sd, next_mix))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e_step1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, <span style="color:#a6e22e">c</span>(r0_mu, r0_sd, r0_mix))
</span></span><span style="display:flex;"><span>param1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step</span>(e_step1<span style="color:#f92672">$</span>dt_lklhd_x_on_y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e_step2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, param1)
</span></span><span style="display:flex;"><span>param2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step</span>(e_step2<span style="color:#f92672">$</span>dt_lklhd_x_on_y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e_step3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, param2)
</span></span><span style="display:flex;"><span>param3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step</span>(e_step3<span style="color:#f92672">$</span>dt_lklhd_x_on_y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e_step4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, param3)
</span></span><span style="display:flex;"><span>param4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step</span>(e_step4<span style="color:#f92672">$</span>dt_lklhd_x_on_y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># xs &lt;- seq(min(y), max(y), length.out=200) # for plot density</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># density1 &lt;- dnorm(xs, mean = mu[1], sd = sd[1])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># density2 &lt;- dnorm(xs, mean = mu[2], sd = sd[2])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hist</span>(y, probability <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">max</span>(density1, density2)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(<span style="color:#a6e22e">density</span>(y), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y1, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rug</span>(y2, ticksize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>, lwd <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, side <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, density1, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, density2, lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param1[1], sd <span style="color:#f92672">=</span> param1[3]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param1[2], sd <span style="color:#f92672">=</span> param1[4]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param2[1], sd <span style="color:#f92672">=</span> param2[3]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param2[2], sd <span style="color:#f92672">=</span> param2[4]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param3[1], sd <span style="color:#f92672">=</span> param3[3]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param3[2], sd <span style="color:#f92672">=</span> param3[4]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param4[1], sd <span style="color:#f92672">=</span> param4[3]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(xs, <span style="color:#a6e22e">dnorm</span>(xs, mean <span style="color:#f92672">=</span> param4[2], sd <span style="color:#f92672">=</span> param4[4]), lw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-5-1.png" alt=""><!-- raw HTML omitted --></p>
<h2 id="simulation">Simulation</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>simEM <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(tol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-4</span>, max_iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># numSim &lt;- 200</span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> max_iter), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">colnames</span>(res) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;mu[1]&#34;</span>, <span style="color:#e6db74">&#34;mu[2]&#34;</span>, <span style="color:#e6db74">&#34;sd[1]&#34;</span>, <span style="color:#e6db74">&#34;sd[2]&#34;</span>, <span style="color:#e6db74">&#34;phi1&#34;</span>, <span style="color:#e6db74">&#34;phi2&#34;</span>, <span style="color:#e6db74">&#34;loglikelihood&#34;</span>)
</span></span><span style="display:flex;"><span>    r0_mu <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">2</span>, min <span style="color:#f92672">=</span> <span style="color:#a6e22e">min</span>(y), max <span style="color:#f92672">=</span> <span style="color:#a6e22e">max</span>(y))
</span></span><span style="display:flex;"><span>    r0_sd <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">2</span>, min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, max <span style="color:#f92672">=</span> <span style="color:#a6e22e">sd</span>(y))
</span></span><span style="display:flex;"><span>    r0_mix <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    e_step0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, <span style="color:#a6e22e">c</span>(r0_mu, r0_sd, r0_mix))
</span></span><span style="display:flex;"><span>    res[1, ] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(r0_mu, r0_sd, r0_mix, e_step0<span style="color:#f92672">$</span>logliklhd)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>(max_iter <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>        e_step_i <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step</span>(y, res[i, ])
</span></span><span style="display:flex;"><span>        res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>] <span style="color:#f92672">&lt;-</span> e_step_i<span style="color:#f92672">$</span>logliklhd
</span></span><span style="display:flex;"><span>        res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step</span>(e_step_i<span style="color:#f92672">$</span>dt_lklhd_x_on_y)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">all</span>(res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, ] <span style="color:#f92672">-</span> res[i, ] <span style="color:#f92672">&lt;</span> tol)) {
</span></span><span style="display:flex;"><span>            break <span style="color:#75715e"># exit the for loop if tolerance is met</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(i <span style="color:#f92672">==</span> max_iter <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) { <span style="color:#75715e"># if tolerance is hit before max_iter number of iterations, i &lt; max_iter-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;WARNING: No convergence in &#34;</span>, max_iter, <span style="color:#e6db74">&#34;times of iterations&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(res[1<span style="color:#f92672">:</span>i, ])
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>res1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM</span>()
</span></span><span style="display:flex;"><span>res2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM</span>()
</span></span><span style="display:flex;"><span>res3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM</span>()
</span></span><span style="display:flex;"><span>res4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM</span>(tol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)
</span></span><span style="display:flex;"><span>res5 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM</span>(tol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># log-likelihood</span>
</span></span><span style="display:flex;"><span>res1<span style="color:#a6e22e">[nrow</span>(res1), ]
</span></span></code></pre></div><pre tabindex="0"><code>        mu[1]         mu[2]         sd[1]         sd[2]          phi1 
        0.254         3.248         2.098         2.183         0.324 
         phi2 loglikelihood 
        0.676     -8249.550 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res2<span style="color:#a6e22e">[nrow</span>(res2), ]
</span></span></code></pre></div><pre tabindex="0"><code>        mu[1]         mu[2]         sd[1]         sd[2]          phi1 
        0.254         3.248         2.098         2.183         0.324 
         phi2 loglikelihood 
        0.676     -8249.550 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res3<span style="color:#a6e22e">[nrow</span>(res3), ]
</span></span></code></pre></div><pre tabindex="0"><code>        mu[1]         mu[2]         sd[1]         sd[2]          phi1 
        0.254         3.248         2.098         2.183         0.324 
         phi2 loglikelihood 
        0.676     -8249.550 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res4<span style="color:#a6e22e">[nrow</span>(res4), ]
</span></span></code></pre></div><pre tabindex="0"><code>        mu[1]         mu[2]         sd[1]         sd[2]          phi1 
        0.254         3.248         2.098         2.183         0.324 
         phi2 loglikelihood 
        0.676     -8249.550 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res5<span style="color:#a6e22e">[nrow</span>(res5), ]
</span></span></code></pre></div><pre tabindex="0"><code>        mu[1]         mu[2]         sd[1]         sd[2]          phi1 
        0.254         3.248         2.098         2.183         0.324 
         phi2 loglikelihood 
        0.676     -8249.550 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>log_likelihood <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(res1[, <span style="color:#ae81ff">7</span>], res2[, <span style="color:#ae81ff">7</span>], res3[, <span style="color:#ae81ff">7</span>], res4[, <span style="color:#ae81ff">7</span>], res5[, <span style="color:#ae81ff">7</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plot</span>(res1[, <span style="color:#ae81ff">7</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, xlab <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;number of iterations&#34;</span>, ylab <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;log-likelihood&#34;</span>, main <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;log-likelihood of the objective function&#34;</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(log_likelihood), <span style="color:#a6e22e">max</span>(log_likelihood)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res2[, <span style="color:#ae81ff">7</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res3[, <span style="color:#ae81ff">7</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res4[, <span style="color:#ae81ff">7</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;magenta&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res5[, <span style="color:#ae81ff">7</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cyan&#34;</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-6-1.png" alt=""><!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>muhat <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(res1[, <span style="color:#ae81ff">1</span>], res1[, <span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plot</span>(res1[, <span style="color:#ae81ff">1</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(muhat), <span style="color:#a6e22e">max</span>(muhat)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res1[, <span style="color:#ae81ff">2</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">legend</span>(<span style="color:#e6db74">&#34;topleft&#34;</span>, legend <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;mu1&#34;</span>, <span style="color:#e6db74">&#34;mu2&#34;</span>), pch <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">17</span>), col <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>), lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>, cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-6-2.png" alt=""><!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>sdhat <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(res1[, <span style="color:#ae81ff">3</span>], res1[, <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plot</span>(res1[, <span style="color:#ae81ff">3</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(sdhat), <span style="color:#a6e22e">max</span>(sdhat)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res1[, <span style="color:#ae81ff">4</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">legend</span>(<span style="color:#e6db74">&#34;topleft&#34;</span>, legend <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;sd1&#34;</span>, <span style="color:#e6db74">&#34;sd2&#34;</span>), pch <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">17</span>), col <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>), lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>, cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-6-3.png" alt=""><!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>phihat <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(res1[, <span style="color:#ae81ff">5</span>], res1[, <span style="color:#ae81ff">6</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">plot</span>(res1[, <span style="color:#ae81ff">5</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(phihat), <span style="color:#a6e22e">max</span>(phihat)))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lines</span>(res1[, <span style="color:#ae81ff">6</span>], pch <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span>, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b&#34;</span>, col <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">legend</span>(<span style="color:#e6db74">&#34;topleft&#34;</span>, legend <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;phi1&#34;</span>, <span style="color:#e6db74">&#34;phi2&#34;</span>), pch <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">17</span>), col <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>), lty <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>, cex <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.5</span>)
</span></span></code></pre></div><p><img src="/image/EM_simulation_files/figure-html/unnamed-chunk-6-4.png" alt=""><!-- raw HTML omitted --></p>
<h1 id="em-algorithm-for-binomial-mixture-models">EM algorithm for binomial mixture models</h1>
<p>There exist more tutorials about the implementation of EM algorithm for coin-flipping binomial mixture models online, most of which are adapted from the following paper:
Do C B, Batzoglou S, What Is the Expectation Maximization Algorithm?[J]. Nature Biotechnology. 2008, 26（8）: 897–899.</p>
<p>The following are adapted from (DO and BATZOGLOU 2008).</p>
<p>Note: to estimate all the parameters in a coin-tossing experiment, it is not enough to do just one experiment, since for each experiment the sufficient statistics is the number of head and tails in the experiment. With only one experiment, it is impossible to estimate 4 parameters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>probH <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.28</span>, <span style="color:#ae81ff">0.73</span>) <span style="color:#75715e"># the prob of showing H for group1 and group2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#numDrawEachExp &lt;- 30</span>
</span></span><span style="display:flex;"><span>alpha <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.4</span>, <span style="color:#ae81ff">0.6</span>) <span style="color:#75715e"># the prob of being group1 and group2</span>
</span></span><span style="display:flex;"><span>numExp <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>drawGroup <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;A&#34;</span>, <span style="color:#e6db74">&#34;B&#34;</span>), numExp, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, prob <span style="color:#f92672">=</span> alpha)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flip_seqs_dt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.table</span>(expID <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>numExp, group <span style="color:#f92672">=</span> drawGroup, numDraw<span style="color:#f92672">=</span><span style="color:#a6e22e">sample</span>(<span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">90</span>,numExp))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flip_seqs_dt_long <span style="color:#f92672">&lt;-</span> flip_seqs_dt[, .(expID <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(expID, time<span style="color:#f92672">=</span>numDraw), group <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(group, time <span style="color:#f92672">=</span> numDraw))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flip_seqs_dt_long[group <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;A&#34;</span>, flip <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Head&#34;</span>, <span style="color:#e6db74">&#34;Tail&#34;</span>), .N, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, prob <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(probH[1], <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> probH[1]))]
</span></span><span style="display:flex;"><span>flip_seqs_dt_long[group <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;B&#34;</span>, flip <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sample</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Head&#34;</span>, <span style="color:#e6db74">&#34;Tail&#34;</span>), .N, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, prob <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(probH[2], <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> probH[2]))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flip_seqs_dt_long[, .N, by<span style="color:#f92672">=</span>.(expID, flip)]
</span></span></code></pre></div><pre tabindex="0"><code>    expID flip  N
 1:     1 Tail  7
 2:     1 Head 12
 3:     2 Head 34
 4:     2 Tail  8
 5:     3 Tail 13
 6:     3 Head 37
 7:     4 Tail 16
 8:     4 Head 27
 9:     5 Head 54
10:     5 Tail 24
11:     6 Head 41
12:     6 Tail 18
13:     7 Tail 14
14:     7 Head  7
15:     8 Head 14
16:     8 Tail 24
17:     9 Head 48
18:     9 Tail 15
19:    10 Tail 18
20:    10 Head 54
21:    11 Head 37
22:    11 Tail 14
23:    12 Tail 29
24:    12 Head 12
25:    13 Tail  3
26:    13 Head  8
27:    14 Head 54
28:    14 Tail 21
29:    15 Tail 23
30:    15 Head 10
31:    16 Head 18
32:    16 Tail  6
33:    17 Head 13
34:    17 Tail  3
35:    18 Tail 35
36:    18 Head 11
37:    19 Head 18
38:    19 Tail  4
39:    20 Head 18
40:    20 Tail 55
41:    21 Head 41
42:    21 Tail 21
43:    22 Tail 56
44:    22 Head 11
45:    23 Tail  9
46:    23 Head  1
47:    24 Tail  8
48:    24 Head  7
49:    25 Head 38
50:    25 Tail 14
51:    26 Tail 24
52:    26 Head 64
53:    27 Head 61
54:    27 Tail 22
55:    28 Head 55
56:    28 Tail 14
57:    29 Head 25
58:    29 Tail  9
59:    30 Tail 24
60:    30 Head 58
    expID flip  N
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>flip_seqs_info <span style="color:#f92672">&lt;-</span> flip_seqs_dt_long[, .N, by<span style="color:#f92672">=</span>.(expID, flip)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####labels = c(&#39;B&#39;, &#39;A&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####flip_seqs = c(&#39;HTHHHTTHHHHTHHHTTHHHHHTHHHHH&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####             &#39;HHTHHHHHTTTTTTTHHTT&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####             &#39;HTHHHHTTHHTTTTTTTHTTTTHHTTT&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####             &#39;HTHTTHHTTHHHHHTHHHHHHHTHHHHHTHHHHHHTTHHHHH&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####             &#39;THHHTHHHTHTTTTTTTTTT&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####e_step_Bin0 &lt;- function(param) {# used for flip_seqs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    # param: thetaA, thetaB</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    #thetaA &lt;- 0.34</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    #thetaB &lt;- 0.81</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    flipInfo0 &lt;- rbindlist(lapply(strsplit(flip_seqs, split=&#34;&#34;), function(flip){ data.table(flip)[, .N, by=flip] }), idcol=&#34;expID&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    flipInfo &lt;- dcast(flipInfo0, expID ~ flip, value.var=&#34;N&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    flipInfo[, liklihd_on_A := dbinom(Head, Head + Tail, param[1]) / (dbinom(Head, Head + Tail, param[1]) + dbinom(Head, Head + Tail, param[2]))]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    flipInfo[, liklihd_on_B := dbinom(Head, Head + Tail, param[2]) / (dbinom(Head, Head + Tail, param[1]) + dbinom(Head, Head + Tail, param[2]))]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####    return(flipInfo)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">####}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e_step_Bin <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(param) {<span style="color:#75715e"># used for flip_seqs_dt_long</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># param: thetaA, thetaB, phiA, phiB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#param &lt;- c(0.34, 0.81, 0.5, 0.5)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#thetaA &lt;- 0.34</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#thetaB &lt;- 0.81</span>
</span></span><span style="display:flex;"><span>    flipInfo0 <span style="color:#f92672">&lt;-</span> flip_seqs_dt_long[, .N, by<span style="color:#f92672">=</span>.(expID, flip)]
</span></span><span style="display:flex;"><span>    flipInfo <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dcast</span>(flipInfo0, expID <span style="color:#f92672">~</span> flip, value.var<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;N&#34;</span>)
</span></span><span style="display:flex;"><span>    flipInfo[, prob_exp_on_A <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dbinom</span>(Head, Head <span style="color:#f92672">+</span> Tail, param[1])]
</span></span><span style="display:flex;"><span>    flipInfo[, prob_exp_on_B <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dbinom</span>(Head, Head <span style="color:#f92672">+</span> Tail, param[2])]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#flipInfo[, prob_exp_on_A := dbinom(Head, Head + Tail, param[1]) / (dbinom(Head, Head + Tail, param[1]) + dbinom(Head, Head + Tail, param[2]))]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#flipInfo[, prob_exp_on_B := dbinom(Head, Head + Tail, param[2]) / (dbinom(Head, Head + Tail, param[1]) + dbinom(Head, Head + Tail, param[2]))]</span>
</span></span><span style="display:flex;"><span>    flipInfo[, joint_prob_A <span style="color:#f92672">:=</span> param[3] <span style="color:#f92672">*</span> prob_exp_on_A]
</span></span><span style="display:flex;"><span>    flipInfo[, joint_prob_B <span style="color:#f92672">:=</span> param[4] <span style="color:#f92672">*</span> prob_exp_on_B]
</span></span><span style="display:flex;"><span>    flipInfo[, prob_A_post <span style="color:#f92672">:=</span> joint_prob_A <span style="color:#f92672">/</span> (joint_prob_A <span style="color:#f92672">+</span> joint_prob_B)]
</span></span><span style="display:flex;"><span>    flipInfo[, prob_B_post <span style="color:#f92672">:=</span> joint_prob_B <span style="color:#f92672">/</span> (joint_prob_A <span style="color:#f92672">+</span> joint_prob_B)]
</span></span><span style="display:flex;"><span>    logliklhd <span style="color:#f92672">&lt;-</span> flipInfo[, <span style="color:#a6e22e">sum</span>(<span style="color:#a6e22e">log</span>(joint_prob_A <span style="color:#f92672">+</span> joint_prob_B))]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">list</span>(logliklhd <span style="color:#f92672">=</span> logliklhd, flipInfoDt <span style="color:#f92672">=</span> flipInfo))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>param0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.34</span>, <span style="color:#ae81ff">0.81</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>e_step_Bin1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(param0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_step_Bin <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(flipInfoDt){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#flipInfoDt &lt;- e_step_Bin(param0)</span>
</span></span><span style="display:flex;"><span>    flipInfoDt[, H_on_A <span style="color:#f92672">:=</span> Head <span style="color:#f92672">*</span> prob_exp_on_A]
</span></span><span style="display:flex;"><span>    flipInfoDt[, T_on_A <span style="color:#f92672">:=</span> Tail <span style="color:#f92672">*</span> prob_exp_on_A]
</span></span><span style="display:flex;"><span>    flipInfoDt[, H_on_B <span style="color:#f92672">:=</span> Head <span style="color:#f92672">*</span> prob_exp_on_B]
</span></span><span style="display:flex;"><span>    flipInfoDt[, T_on_B <span style="color:#f92672">:=</span> Tail <span style="color:#f92672">*</span> prob_exp_on_B]
</span></span><span style="display:flex;"><span>    thetaA <span style="color:#f92672">&lt;-</span> flipInfoDt[, <span style="color:#a6e22e">sum</span>(H_on_A) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(H_on_A <span style="color:#f92672">+</span> T_on_A)]
</span></span><span style="display:flex;"><span>    thetaB <span style="color:#f92672">&lt;-</span> flipInfoDt[, <span style="color:#a6e22e">sum</span>(H_on_B) <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(H_on_B <span style="color:#f92672">+</span> T_on_B)]
</span></span><span style="display:flex;"><span>    phiA <span style="color:#f92672">&lt;-</span> flipInfoDt[, <span style="color:#a6e22e">sum</span>(prob_A_post)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    phiB <span style="color:#f92672">&lt;-</span> flipInfoDt[, <span style="color:#a6e22e">sum</span>(prob_B_post)<span style="color:#f92672">/</span>.N]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(<span style="color:#a6e22e">c</span>(thetaA, thetaB, phiA, phiB))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#param0 &lt;- c(0.19, .91)</span>
</span></span><span style="display:flex;"><span>param0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.34</span>, <span style="color:#ae81ff">0.81</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>e_step_Bin1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(param0)
</span></span><span style="display:flex;"><span>m_step_Bin1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step_Bin</span>(e_step_Bin1<span style="color:#f92672">$</span>flipInfoDt)
</span></span><span style="display:flex;"><span>e_step_Bin2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(m_step_Bin1)
</span></span><span style="display:flex;"><span>m_step_Bin2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step_Bin</span>(e_step_Bin2<span style="color:#f92672">$</span>flipInfoDt)
</span></span><span style="display:flex;"><span>e_step_Bin3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(m_step_Bin2)
</span></span><span style="display:flex;"><span>m_step_Bin3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step_Bin</span>(e_step_Bin3<span style="color:#f92672">$</span>flipInfoDt)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_step_Bin1
</span></span></code></pre></div><pre tabindex="0"><code>[1] 0.318 0.765 0.307 0.693
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_step_Bin2
</span></span></code></pre></div><pre tabindex="0"><code>[1] 0.303 0.745 0.295 0.705
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_step_Bin3
</span></span></code></pre></div><pre tabindex="0"><code>[1] 0.294 0.737 0.291 0.709
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e">### Simulation</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>simEM_Bin <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(tol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-4</span>, max_iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># numSim &lt;- 200</span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> max_iter), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">colnames</span>(res) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;thetaA&#34;</span>, <span style="color:#e6db74">&#34;thetaB&#34;</span>, <span style="color:#e6db74">&#34;phiA&#34;</span>, <span style="color:#e6db74">&#34;phiB&#34;</span>, <span style="color:#e6db74">&#34;loglikelihood&#34;</span>)
</span></span><span style="display:flex;"><span>    r0_theta <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">runif</span>(<span style="color:#ae81ff">2</span>, min <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, max <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    r0_phi <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    e_step0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(<span style="color:#a6e22e">c</span>(r0_theta, r0_phi))
</span></span><span style="display:flex;"><span>    res[1, ] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(r0_theta, r0_phi, e_step0<span style="color:#f92672">$</span>logliklhd)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>(max_iter <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>        e_step_i <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">e_step_Bin</span>(res[i, ])
</span></span><span style="display:flex;"><span>        res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>] <span style="color:#f92672">&lt;-</span> e_step_i<span style="color:#f92672">$</span>logliklhd
</span></span><span style="display:flex;"><span>        res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">m_step_Bin</span>(e_step_i<span style="color:#f92672">$</span>flipInfoDt)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">if </span>(<span style="color:#a6e22e">all</span>(res[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, ] <span style="color:#f92672">-</span> res[i, ] <span style="color:#f92672">&lt;</span> tol)) {
</span></span><span style="display:flex;"><span>            break <span style="color:#75715e"># exit the for loop if tolerance is met</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">if </span>(i <span style="color:#f92672">==</span> max_iter <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) { <span style="color:#75715e"># if tolerance is hit before max_iter number of iterations, i &lt; max_iter-1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;WARNING: No convergence in &#34;</span>, max_iter, <span style="color:#e6db74">&#34;times of iterations&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">return</span>(res[1<span style="color:#f92672">:</span>i, ])
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>res1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM_Bin</span>()
</span></span><span style="display:flex;"><span>res2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM_Bin</span>()
</span></span><span style="display:flex;"><span>res3 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM_Bin</span>()
</span></span><span style="display:flex;"><span>res4 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM_Bin</span>(tol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-6</span>)
</span></span><span style="display:flex;"><span>res5 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">simEM_Bin</span>(tol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># log-likelihood</span>
</span></span><span style="display:flex;"><span>res1<span style="color:#a6e22e">[nrow</span>(res1), ]
</span></span></code></pre></div><pre tabindex="0"><code>       thetaA        thetaB          phiA          phiB loglikelihood 
       0.7319        0.7319        0.9169        0.0831     -232.5019 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res2<span style="color:#a6e22e">[nrow</span>(res2), ]
</span></span></code></pre></div><pre tabindex="0"><code>       thetaA        thetaB          phiA          phiB loglikelihood 
        0.732         0.280         0.714         0.286       -87.759 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res3<span style="color:#a6e22e">[nrow</span>(res3), ]
</span></span></code></pre></div><pre tabindex="0"><code>       thetaA        thetaB          phiA          phiB loglikelihood 
        0.280         0.732         0.286         0.714       -87.769 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res4<span style="color:#a6e22e">[nrow</span>(res4), ]
</span></span></code></pre></div><pre tabindex="0"><code>       thetaA        thetaB          phiA          phiB loglikelihood 
       0.7319        0.7319        0.9511        0.0489     -232.5013 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>res5<span style="color:#a6e22e">[nrow</span>(res5), ]
</span></span></code></pre></div><pre tabindex="0"><code>       thetaA        thetaB          phiA          phiB loglikelihood 
        0.280         0.732         0.286         0.714       -87.769 
</code></pre>
    <hr>

  <footer>
  
  
  </footer>
  </body>
</html>

